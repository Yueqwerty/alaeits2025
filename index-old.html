<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Programa Interactivo del Seminario v2.6 (Corregido)</title>
    
    <!-- Se añade la librería html2canvas para la captura de pantalla -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibVc7AyX+KcrEkCRIR7JBUA/qkOdXsmw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
      :root {
        --color-primary: #a7c7e7; --color-primary-light: #e0efff; --color-secondary: #c1e1c1;
        --color-secondary-light: #e8f5e9; --color-background: #fdfdfd; --color-surface: #ffffff;
        --color-text-primary: #333745; --color-text-secondary: #5e6c84; --color-text-subtle: #8993a4;
        --color-border: #dfe1e6; --color-highlight: #fdfd96; --color-highlight-bg: #fffde7;
        --border-radius: 8px; --shadow-sm: 0 1px 3px rgba(23, 43, 77, 0.08);
        --shadow-md: 0 4px 12px rgba(23, 43, 77, 0.12);
        --sala-header-width: 40px; /* <--- AJUSTADO AQUÍ para hacerlo más delgado, antes 120px */
        --grid-gap: 16px;
      }
      *, *::before, *::after { box-sizing: border-box; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--color-background); color: var(--color-text-primary); margin: 0; line-height: 1.5; font-size: 16px; }
      #seminar-container { max-width: 100%; margin: 0 auto; background-color: var(--color-surface); box-shadow: var(--shadow-md); overflow: hidden; }
      .sticky-header { position: sticky; top: 0; z-index: 100; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
      .header { padding: 1.5rem 1rem; border-bottom: 1px solid var(--color-border); }
      .header h1 { margin: 0 0 0.25rem; font-size: 1.75em; font-weight: 600; color: #333745; }
      .header p { margin: 0 0 1rem; color: var(--color-text-secondary); }
      .header-info { font-size: 0.8em; color: var(--color-text-subtle); margin-top: -10px; margin-bottom: 1rem;}
      .controls-wrapper { display: flex; flex-direction: column; gap: 1rem; }
      
      /* === Estilos de búsqueda mejorados === */
      .search-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center; /* Asegura la alineación vertical de todos los elementos */
      }
      
      /* Contenedor del input de búsqueda con el botón de borrado inline */
      .search-input-wrapper {
        flex-grow: 1; /* Este contenedor toma el espacio flexible dentro de search-controls */
        position: relative; /* Para posicionar el botón de borrar */
      }

      /* Estilos para el campo de búsqueda real */
      .search-controls input#searchId { /* Más específico para evitar conflictos */
        width: 100%; /* El input llena el 100% del ancho de su contenedor (.search-input-wrapper) */
        padding: 0.6rem 0.8rem;
        border: 1px solid #c1c7d0;
        border-radius: 4px;
        font-size: 1em;
        transition: border-color 0.2s, box-shadow 0.2s;
        background-color: #fafdff;
        padding-right: 2.5rem; /* Deja espacio para el botón de borrado */
      }
      .search-controls input#searchId:focus { /* Estilo de foco específico */
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px var(--color-primary-light);
      }
      
      /* Estilos para el botón de borrado dentro del input */
      .clear-search-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--color-text-subtle);
        font-size: 1.1em; /* Ligeramente más grande para mejor visibilidad y área de clic */
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        padding: 0.2rem;
        border-radius: 50%;
        width: 1.8em;
        height: 1.8em;
        display: flex; /* Para centrar el símbolo 'x' */
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, color 0.2s, visibility 0s, opacity 0.2s;
        visibility: hidden; /* Oculto por defecto */
        opacity: 0;
        pointer-events: none; /* No interactuable cuando está oculto */
      }
      .clear-search-btn:hover {
        background-color: #e9ecef;
        color: var(--color-text-primary);
      }
      .clear-search-btn.visible {
        visibility: visible;
        opacity: 1;
        pointer-events: all;
      }
      /* === Fin de estilos de búsqueda mejorados === */

      .btn { padding: 0.6rem 1rem; border: 1px solid var(--color-border); border-radius: 4px; font-size: 0.9em; font-weight: 500; cursor: pointer; background-color: #f4f5f7; color: var(--color-text-primary); transition: background-color 0.2s, border-color 0.2s, transform 0.1s; white-space: nowrap; }
      .btn:hover { background-color: #ebecf0; }
      .btn:active { transform: translateY(1px); }
      .btn.primary { background-color: var(--color-primary); color: var(--color-text-primary); border-color: var(--color-primary); font-weight: 600; }
      .btn.primary:hover { background-color: #b8d2f0; }
      .filter-controls { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
      .filter-group button.active { background-color: var(--color-primary-light); color: #0052cc; border-color: var(--color-primary); font-weight: 600; }
      .filter-controls select { padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); border-radius: 4px; font-size: 0.9em; background-color: #fff; }
      #status-bar { padding: 0.75rem 1rem; font-size: 0.9em; min-height: 1.4em; transition: all 0.3s; font-weight: 500;}
      .status-success { background-color: var(--color-secondary-light); color: #006644; }
      .status-error { background-color: #ffebe6; color: #bf2600; }
      .tab-container { display: flex; border-bottom: 1px solid var(--color-border); overflow-x: auto; padding: 0 1rem; }
      .tab-button { padding: 0.8rem 1rem; cursor: pointer; border: none; background-color: transparent; font-size: 1em; font-weight: 500; color: var(--color-text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; transition: color 0.2s, border-color 0.2s; flex-shrink: 0; }
      .tab-button.active { color: #0052cc; font-weight: 600; border-bottom-color: var(--color-primary); }
      #schedule-wrapper { background-color: var(--color-background); }
      .schedule-grid { display: grid; gap: var(--grid-gap); padding: var(--grid-gap); }
      .no-results { padding: 4rem 1rem; text-align: center; color: var(--color-text-subtle); font-size: 1.1em; }
      .time-header-wrapper, .sala-header { display: none; }
      .session-card { border-radius: var(--border-radius); box-shadow: var(--shadow-sm); background-color: var(--color-surface); display: flex; flex-direction: column; transition: all 0.2s ease-in-out; border: 1px solid var(--color-border); overflow: hidden; }
      .session-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
      .ponencia-card { border-left: 5px solid var(--color-primary); }
      .simposio-card { border-left: 5px solid var(--color-secondary); }
      .card-header {
        padding: 0.75rem 1rem; background-color: #fafafa; border-bottom: 1px solid var(--color-border);
        display: flex; justify-content: space-between; align-items: center;
      }
      .card-header-title { font-weight: 600; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; }
      .ponencia-card .card-header-title { color: #0052cc; }
      .simposio-card .card-header-title { color: #006644; }
      .card-meta { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; color: var(--color-text-subtle); font-size: 0.85em; padding: 0.5rem 1rem; }
      .meta-item { display: flex; align-items: center; gap: 0.4rem; }
      .meta-item svg { width: 16px; height: 16px; flex-shrink: 0; fill: currentColor; }
      .card-content { padding: 1rem; flex-grow: 1; }
      .mesa-title { font-weight: 600; color: var(--color-text-primary); font-size: 1.2em; margin: 0 0 1rem; line-height: 1.3; }
      .ponencia-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 1.25rem; }
      .ponencia-item { padding-left: 1rem; border-left: 3px solid var(--color-border); transition: border-color 0.3s; }
      .ponencia-meta { font-size: 0.8em; color: var(--color-text-subtle); margin-bottom: 0.1rem; font-weight: 500; }
      .ponencia-title { font-weight: 500; font-size: 1em; }
      .ponencia-authors { font-style: italic; color: var(--color-text-secondary); font-size: 0.9em; }
      .ponencia-moderador { font-size: 0.85em; color: #6a5acd; font-weight: 500; margin-top: 0.25rem; }
      .highlight { border-color: var(--color-highlight) !important; box-shadow: 0 0 0 3px var(--color-highlight-bg), 0 0 12px rgba(255, 0, 217, 0.8) !important; transform: scale(1.02); }
      .ponencia-item.highlight { border-left-color: var(--color-highlight) !important; }
      .day-container { padding: 1.5rem 1rem; }
      .special-event { display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--color-border); }
      .special-event:last-child { border-bottom: none; }
      .event-time { font-weight: 600; color: #5a81ad; width: 100px; flex-shrink: 0; }
      .event-details { flex-grow: 1; }
      .event-title { font-weight: 600; font-size: 1.1em; }
      .event-location { color: var(--color-text-secondary); }
      #program-summary-footer { padding: 1.5rem 1rem; border-top: 1px solid var(--color-border); line-height: 1.6; background-color: #fafcff; }
      #program-summary-footer h3 { margin: 0 0 0.5rem; font-size: 1.2em; color: #333745; }
      #program-summary-footer p { margin: 0.25rem 0; }
      .capture-btn {
        background: none; border: none; cursor: pointer; padding: 4px;
        border-radius: 50%; width: 32px; height: 32px; display: flex;
        align-items: center; justify-content: center; color: var(--color-text-subtle);
        transition: background-color 0.2s, color 0.2s;
      }
      .capture-btn:hover { background-color: #e9ecef; color: var(--color-text-primary); }
      .capture-btn svg { width: 20px; height: 20px; }

      @media (min-width: 768px) { .header { padding: 2rem; } .controls-wrapper { flex-direction: row; justify-content: space-between; align-items: center; } .filter-controls { flex-wrap: nowrap; } #seminar-container { max-width: 95%; margin: 1.5rem auto; border-radius: var(--border-radius); } .day-container, .tab-container, #program-summary-footer { padding-left: 2rem; padding-right: 2rem; } }
      @media (min-width: 1024px) {
        .mobile-only-header { display: none; }
        .sala-header {
          background-color: #f0f3f7; font-weight: 600; text-align: center; display: flex;
          align-items: center; justify-content: center; border-radius: 4px; position: sticky;
          left: 0; z-index: 15;
          width: var(--sala-header-width); /* Utiliza la variable ajustada */
          min-height: 100%; font-size: 1.1em; box-shadow: 2px 0 5px rgba(0,0,0,0.05);
          /* === NUEVOS ESTILOS PARA TEXTO VERTICAL === */
          writing-mode: vertical-lr; /* Escribe el texto de arriba a abajo, de izquierda a derecha */
          text-orientation: sideways; /* Orienta los caracteres para lectura lateral */
          white-space: nowrap; /* Evita que el texto se rompa en varias líneas si es muy largo */
          /* Opcional: ajustar el tamaño de fuente si el texto vertical se ve muy grande */
          font-size: 0.95em;
          /* === FIN NUEVOS ESTILOS === */
        }
        .time-header-wrapper { display: block; position: sticky; top: 0; background-color: var(--color-background); z-index: 10; }
        .time-header { background-color: #f0f3f7; font-weight: 600; text-align: center; padding: 0.75rem; border-radius: 4px; }
        #schedule-wrapper { max-height: calc(100vh - 380px); overflow: auto; }
      }
    </style>
</head>
<body>
    <div id="seminar-container">
        <div class="sticky-header">
            <div class="header">
                <h1>Programa Interactivo del Seminario</h1>
                <p>Explora las sesiones. Utiliza la búsqueda o los filtros para navegar el programa.</p>
                <div class="header-info">Este programa se actualiza en tiempo real desde la base de datos del comité.</div>
                <div class="controls-wrapper">
                    <div class="search-controls">
                        <div class="search-input-wrapper">
                            <input type="text" id="searchId" placeholder="Buscar por ID, Título o Autor..." aria-label="Buscar" />
                            <button id="clear-search-inline-btn" class="clear-search-btn" title="Borrar búsqueda">
                                &times;
                            </button>
                        </div>
                        <button class="btn primary" onclick="buscar()">Buscar</button>
                        <button class="btn" onclick="limpiarBusqueda()">Limpiar</button>
                    </div>
                    <div class="filter-controls">
                        <div class="filter-group" id="filter-type">
                            <button class="btn active" data-type="all">Todos</button>
                            <button class="btn" data-type="simposio">Simposios</button>
                            <button class="btn" data-type="ponencia">Ponencias</button>
                        </div>
                        <select id="filter-sala" aria-label="Filtrar por sala"></select>
                        <select id="filter-horario" aria-label="Filtrar por horario"></select>
                        <button id="reset-filters" class="btn">Reiniciar</button>
                        <button id="copy-link" class="btn">Copiar Enlace</button>
                    </div>
                </div>
            </div>
            <div id="status-bar"></div>
            <div id="tab-container" class="tab-container"></div>
        </div>
        <div id="loading-state" style="padding: 40px; text-align: center; font-size: 1.2em;">Cargando programa oficial...</div>
        <div id="schedule-wrapper" style="display: none;"><div id="schedule-content"></div></div>
        <div id="program-summary-footer"></div>
    </div>

<script>
    const CONFIG = {
        numSalas: 26, salaReservaNombre: "Auditorio de Reserva (Sala 26)", duracionPonenciaMin: 12,
        dias: [ { nombre: 'Lunes 13 de octubre', tipo: 'especial', eventos: [ { horario: '08:00', titulo: 'Inscripción y Acreditación', lugar: 'Museo de la Memoria (Matucana 501)' }, { horario: '10:00 – 12:30', titulo: 'Acto Inaugural', lugar: 'Museo de la Memoria' }, { horario: '12:30 – 15:00', titulo: 'Almuerzo libre' }, { horario: '15:00 – 17:50', titulo: 'Presentación Mesas (Apertura)', lugar: 'Universidad Central (Lord Cochrane 417, Santiago)' }, { horario: '17:00 – 19:00', titulo: 'Actividades Estudiantiles', lugar: 'Universidad de las Américas (República Nº71 – Aula Magna)' }, { horario: '18:00', titulo: 'Cierre del día y presentación del programa', lugar: 'Universidad Central' }, ] }, { nombre: 'Martes 14 de octubre', tipo: 'grid', bloques: [ { inicio: '08:30', fin: '10:10', nombre: 'Mesa 1' }, { inicio: '10:20', fin: '12:00', nombre: 'Mesa 2' }, { inicio: '12:10', fin: '13:50', nombre: 'Mesa 3' }, { inicio: '15:00', fin: '16:40', nombre: 'Mesa 4' }, { inicio: '16:50', fin: '18:30', nombre: 'Mesa 5' }, ] }, { nombre: 'Miércoles 15 de octubre', tipo: 'grid', bloques: [ { inicio: '08:30', fin: '10:10', nombre: 'Mesa 6' }, { inicio: '10:20', fin: '12:00', nombre: 'Mesa 7' }, { inicio: '12:10', fin: '13:50', nombre: 'Mesa 8' }, { inicio: '14:00', fin: '15:30', nombre: 'Mesa 9' }, ] }, ],
        iconos: { 
            reloj: `<svg viewBox="0 0 24 24"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v6h6v-2h-4z"></path></svg>`, 
            id: `<svg viewBox="0 0 24 24"><path d="M10 11h4v2h-4z"></path><path d="M10 3H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-8l-2-2z"></path></svg>`, 
            sala: `<svg viewBox="0 0 24 24"><path d="M12 6.5A2.5 2.5 0 0 1 14.5 9a2.5 2.5 0 0 1-2.5 2.5A2.5 2.5 0 0 1 9.5 9A2.5 2.5 0 0 1 12 6.5M12 2a7 7 0 0 1 7 7c0 5.25-7 13-7 13S5 14.25 5 9a7 7 0 0 1 7-7m0 2a5 5 0 0 0-5 5c0 1.96 1.41 5.21 5 9.78 3.59-4.57 5-7.82 5-9.78a5 5 0 0 0-5-5Z"/></svg>`,
            camara: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M9 4V2.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5V4h1.5A3.5 3.5 0 0 1 20 7.5v9A3.5 3.5 0 0 1 16.5 20h-9A3.5 3.5 0 0 1 4 16.5v-9A3.5 3.5 0 0 1 7.5 4H9Zm3 14a5 5 0 1 0 0-10a5 5 0 0 0 0 10Zm0-2a3 3 0 1 1 0-6a3 3 0 0 1 0 6Z"></path></svg>`
        }
    };
    const masterScheduleURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTeiEquNfK-SqUuAjFui6V6oIOiZPt4rA71hLATqU1h_8HlseDHuBpjW4sm3b0Q5APziFZ7wk9PQG5E/pub?output=csv";
    let fullSchedule = [];
    let currentFilters = { type: 'all', sala: 'all', horario: 'all' };
    let currentDay = CONFIG.dias[0].nombre;

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch(`${masterScheduleURL}&timestamp=${new Date().getTime()}`);
            if (!response.ok) throw new Error("No se pudo cargar el programa. Verifique el enlace.");
            const tableData = parseCSV(await response.text());
            fullSchedule = reconstructScheduleFromTable(tableData);
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('schedule-wrapper').style.display = 'block';
            setupControls();
            applyFiltersFromURL();
            switchTab(currentDay);
        } catch (error) { console.error('Error al iniciar:', error); document.getElementById('loading-state').innerText = `Error: ${error.message}`; }
    });

    function parseCSV(text) { const lines = text.trim().replace(/\r/g, '').split('\n'); if (lines.length < 2) return []; const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '')); return lines.slice(1).map(line => { if (!line) return null; const values = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, '')); return headers.reduce((obj, header, index) => ({ ...obj, [header]: values[index] || '' }), {}); }).filter(Boolean); }
    
    function reconstructScheduleFromTable(tableData) {
        const mesas = {};
        tableData.forEach(row => {
            if (!row.ID_Mesa) return;
            const mesaId = row.ID_Mesa;
            if (!mesas[mesaId]) {
                mesas[mesaId] = { id: mesaId, dia: row.Dia.trim(), horarioBloque: row.Horario_Bloque, sala: row.Sala, titulo: row.Titulo_Mesa, esSimposio: row.Tipo_Item === 'Simposio', items: [] };
            }
            const autores = row.Autores_Item.split(';').map(a => a.trim()).filter(Boolean);
            mesas[mesaId].items.push({ id: row.ID_Item, titulo: row.Titulo_Item, autores: autores, tipo: row.Tipo_Item, moderador: autores[0] || '' });
        });
        Object.values(mesas).forEach(mesa => {
            if (!mesa.esSimposio) {
                let horaActual = mesa.horarioBloque.split(' - ')[0];
                mesa.items.forEach(item => {
                    if (item.id !== 'DISC') {
                        const horaFin = addMinutes(horaActual, CONFIG.duracionPonenciaMin);
                        item.horario = `${horaActual} - ${horaFin}`;
                        horaActual = horaFin;
                    }
                });
            }
        });
        return Object.values(mesas);
    }
    
    function renderSessionCard(mesa) {
        const cardClass = mesa.esSimposio ? 'simposio-card' : 'ponencia-card';
        const cardHeader = mesa.esSimposio ? 'Simposio' : 'Mesa de Ponencias';
        const idDisplay = mesa.esSimposio ? `ID Simposio: ${mesa.items[0].id}` : `ID Mesa: ${mesa.id}`;
        const salaNombre = mesa.sala == 26 ? CONFIG.salaReservaNombre : `Sala ${mesa.sala}`;
        const safeFileName = `${cardHeader.replace(/ /g, '_')}_${mesa.id}`;

        return `<div class="session-card ${cardClass}" id="card-${mesa.id}">
            <div class="card-header">
                <div class="card-header-title">${cardHeader}</div>
                <button class="capture-btn" title="Exportar como Imagen" onclick="captureCard('card-${mesa.id}', '${safeFileName}')">
                    ${CONFIG.iconos.camara}
                </button>
            </div>
            <div class="card-meta">
                <div class="meta-item mobile-only-header"><strong>${salaNombre}</strong></div>
                <div class="meta-item">${CONFIG.iconos.reloj}<span>${mesa.horarioBloque}</span></div>
                <div class="meta-item">${CONFIG.iconos.sala}<span>${salaNombre}</span></div>
                <div class="meta-item">${CONFIG.iconos.id}<span>${idDisplay}</span></div>
            </div>
            <div class="card-content">
                <div class="mesa-title">${mesa.titulo}</div>
                <ul class="ponencia-list">
                    ${mesa.items.map(item => `<li class="ponencia-item" id="item-${item.id}">
                        ${!mesa.esSimposio && item.id !== 'DISC' ? `<div class="ponencia-meta">${item.horario} | ID: ${item.id}</div>` : ''}
                        <div class="ponencia-title">${item.titulo}</div>
                        <div class="ponencia-authors">${item.autores.join(', ')}</div>
                        ${item.moderador ? `<div class="ponencia-moderador">Moderador: ${item.moderador}</div>` : ''}
                    </li>`).join('')}
                </ul>
            </div>
        </div>`;
    }

    function captureCard(elementId, fileName = 'programa-seminario') {
        const elementToCapture = document.getElementById(elementId);
        if (!elementToCapture) {
            console.error('Elemento no encontrado para capturar:', elementId);
            showStatus('Error: No se pudo encontrar la tarjeta para exportar.', 'error');
            return;
        }

        showStatus('Exportando imagen, por favor espera...', 'success');

        const computedStyles = getComputedStyle(elementToCapture);
        const resolvedBgColor = computedStyles.getPropertyValue('--color-surface').trim();
        
        html2canvas(elementToCapture, {
            scale: 2,
            useCORS: true,
            backgroundColor: resolvedBgColor || '#ffffff', 
            onclone: (document, element) => {
                element.style.boxShadow = 'none';
                element.style.transform = 'none';
            }
        }).then(canvas => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = `${fileName}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus('¡Imagen exportada con éxito!', 'success');
        }).catch(err => {
            console.error('Error al usar html2canvas:', err);
            showStatus('Ocurrió un error al exportar la imagen.', 'error');
        });
    }

    function setupControls() {
        const tabContainer = document.getElementById('tab-container');
        tabContainer.innerHTML = CONFIG.dias.map(dia => `<button class="tab-button" data-day="${dia.nombre}">${dia.nombre}</button>`).join('');
        tabContainer.addEventListener('click', e => { if (e.target.classList.contains('tab-button')) switchTab(e.target.dataset.day); });
        const salaSelect = document.getElementById('filter-sala');
        salaSelect.innerHTML = `<option value="all">Todas las Salas</option>` + Array.from({ length: 25 }, (_, i) => `<option value="${i + 1}">Sala ${i + 1}</option>`).join('') + `<option value="26">${CONFIG.salaReservaNombre}</option>`;
        
        const searchInput = document.getElementById('searchId');
        const clearSearchInlineBtn = document.getElementById('clear-search-inline-btn');

        searchInput.addEventListener('keyup', e => {
            if (e.key === 'Enter') buscar();
            toggleClearSearchButton(); // Mostrar/ocultar el botón de borrado inline
        });
        searchInput.addEventListener('input', toggleClearSearchButton); // También para cambios no de teclado

        clearSearchInlineBtn.addEventListener('click', () => {
            limpiarBusqueda();
            searchInput.focus(); // Mantener el foco en el input después de limpiar
            // No es necesario llamar a toggleClearSearchButton() aquí, ya que limpiarBusqueda() lo hará
        });
        
        // Función para mostrar/ocultar el botón de borrado inline
        function toggleClearSearchButton() {
            if (searchInput.value.trim() !== '') {
                clearSearchInlineBtn.classList.add('visible');
            } else {
                clearSearchInlineBtn.classList.remove('visible');
            }
        }

        salaSelect.addEventListener('change', e => { currentFilters.sala = e.target.value; applyFiltersAndRender(); });
        document.getElementById('filter-horario').addEventListener('change', e => { currentFilters.horario = e.target.value; applyFiltersAndRender(); });
        document.getElementById('filter-type').addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { currentFilters.type = e.target.dataset.type; document.querySelectorAll('#filter-type button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); applyFiltersAndRender(); } });
        document.getElementById('reset-filters').addEventListener('click', resetFiltersAndRender);
        document.querySelector('.search-controls .btn:last-of-type').addEventListener('click', limpiarBusqueda);
        document.getElementById('copy-link').addEventListener('click', copyLinkToView);
        updateProgramSummaryFooter();

        toggleClearSearchButton();
    }
    
    function buscar() {
        limpiarResaltado();
        const searchTerm = document.getElementById('searchId').value.trim().toLowerCase();
        if (!searchTerm) { showStatus('Por favor, ingresa un término para buscar.', 'error'); return; }
        let foundItem = null;
        for (const mesa of fullSchedule) {
            if (mesa.titulo.toLowerCase().includes(searchTerm)) { foundItem = { mesa, item: null }; break; }
            for (const item of mesa.items) { if (item.id?.toLowerCase().includes(searchTerm) || item.titulo?.toLowerCase().includes(searchTerm) || item.autores?.join(' ').toLowerCase().includes(searchTerm)) { foundItem = { mesa, item }; break; } }
            if (foundItem) break;
        }
        if (foundItem) {
            const { mesa, item } = foundItem;
            currentFilters.sala = String(mesa.sala).trim();
            currentFilters.horario = mesa.horarioBloque.trim();
            currentFilters.type = 'all';
            switchTab(mesa.dia);
            setTimeout(() => {
                const elementToHighlight = item ? document.getElementById(`item-${item.id}`) : document.getElementById(`card-${mesa.id}`);
                if (elementToHighlight) {
                    elementToHighlight.classList.add('highlight');
                    if (item) elementToHighlight.closest('.session-card')?.classList.add('highlight');
                    elementToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    showStatus(`Resultado encontrado para "${searchTerm}". Vista enfocada.`, 'success');
                }
            }, 150);
        } else {
            showStatus(`No se encontraron resultados para "${searchTerm}".`, 'error');
        }
    }
    
    function renderMobileList(mesas) {
      return `<div class="schedule-list">${mesas.map(renderSessionCard).join('')}</div>`;
    }

    function renderSpecialDay(dayConfig) {
        return `<div class="day-container">
            ${dayConfig.eventos.map(evento => `
                <div class="special-event">
                    <div class="event-time">${evento.horario}</div>
                    <div class="event-details">
                        <div class="event-title">${evento.titulo}</div>
                        <div class="event-location">${evento.lugar}</div>
                    </div>
                </div>
            `).join('')}
        </div>`;
    }

    function switchTab(dayToShow) { const targetDayConfig = CONFIG.dias.find(d => d.nombre.toLowerCase() === dayToShow.toLowerCase().trim()); if (!targetDayConfig) { console.error("Intento de cambiar a un día inválido:", dayToShow); return; } currentDay = targetDayConfig.nombre; document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.day === currentDay)); updateFilterControlsUI(targetDayConfig); applyFiltersAndRender(); }
    function applyFiltersAndRender() { const dayConfig = CONFIG.dias.find(d => d.nombre === currentDay); const scheduleContent = document.getElementById('schedule-content'); if (dayConfig.tipo === 'grid') { const daySchedule = fullSchedule.filter(m => m.dia.toLowerCase() === dayConfig.nombre.toLowerCase()); const filteredMesas = daySchedule.filter(mesa => (currentFilters.type === 'all' || (currentFilters.type === 'simposio' ? mesa.esSimposio : !mesa.esSimposio)) && (currentFilters.sala === 'all' || String(mesa.sala).trim() === currentFilters.sala) && (currentFilters.horario === 'all' || mesa.horarioBloque.trim() === currentFilters.horario)); if (filteredMesas.length === 0) { scheduleContent.innerHTML = `<div class="no-results">No se encontraron sesiones con los filtros aplicados.</div>`; } else { scheduleContent.innerHTML = window.innerWidth >= 1024 ? renderDesktopGrid(dayConfig, filteredMesas) : renderMobileList(filteredMesas); } } else { scheduleContent.innerHTML = renderSpecialDay(dayConfig); } updateURLHash(); }
    function renderDesktopGrid(dayConfig, mesas) { const salasToShow = currentFilters.sala === 'all' ? Array.from({ length: CONFIG.numSalas }, (_, i) => i + 1) : [parseInt(currentFilters.sala)]; const bloquesToShow = currentFilters.horario === 'all' ? dayConfig.bloques : dayConfig.bloques.filter(b => `${b.inicio} - ${b.fin}` === currentFilters.horario); let gridHTML = `<div class="schedule-grid" style="grid-template-columns: var(--sala-header-width) repeat(${bloquesToShow.length}, minmax(380px, 1fr));"><div class="time-header-wrapper"></div>${bloquesToShow.map(b => `<div class="time-header-wrapper"><div class="time-header"><div>${b.nombre}</div><div>${b.inicio} - ${b.fin}</div></div></div>`).join('')}`; salasToShow.forEach(salaNum => { const rowCells = bloquesToShow.map(b => { const mesa = mesas.find(m => String(m.sala).trim() === String(salaNum) && m.horarioBloque.trim() === `${b.inicio} - ${b.fin}`); return mesa ? renderSessionCard(mesa) : `<div class="empty-cell"></div>`; }); if (rowCells.some(cell => !cell.includes('empty-cell'))) { gridHTML += `<div class="sala-header">${salaNum === 26 ? CONFIG.salaReservaNombre : `Sala ${salaNum}`}</div>${rowCells.join('')}`; } }); return gridHTML + `</div>`; }
    function resetFiltersAndRender() { resetFiltersState(); limpiarBusquedaInput(); applyFiltersAndRender(); showStatus('Filtros reiniciados. Vista completa restaurada.', 'success'); }
    function limpiarBusqueda() { 
        const searchInput = document.getElementById('searchId');
        searchInput.value = ''; 
        // Ocultar el botón de borrado inline después de limpiar
        const clearSearchInlineBtn = document.getElementById('clear-search-inline-btn');
        if (clearSearchInlineBtn) {
            clearSearchInlineBtn.classList.remove('visible');
        }
        limpiarResaltado(); 
        resetFiltersAndRender(); 
    }
    function resetFiltersState() { currentFilters = { type: 'all', sala: 'all', horario: 'all' }; }
    function updateFilterControlsUI(dayConfig) { const enabled = dayConfig.tipo === 'grid'; ['filter-sala', 'filter-horario', 'filter-type', 'reset-filters', 'copy-link'].forEach(id => { const el = document.getElementById(id); if (el) el.style.display = enabled ? (el.tagName === 'SELECT' ? 'inline-block' : 'flex') : 'none'; }); const horarioSelect = document.getElementById('filter-horario'); if (enabled) { horarioSelect.innerHTML = `<option value="all">Todos los Horarios</option>` + dayConfig.bloques.map(b => `<option value="` + b.inicio + ` - ` + b.fin + `">` + b.inicio + ` - ` + b.fin + ` (` + b.nombre + `)</option>`).join(''); } else { horarioSelect.innerHTML = `<option value="all">No aplica</option>`; } document.getElementById('filter-sala').value = currentFilters.sala; document.getElementById('filter-horario').value = currentFilters.horario; document.querySelectorAll('#filter-type button').forEach(btn => btn.classList.remove('active')); document.querySelector(`#filter-type button[data-type="${currentFilters.type}"]`)?.classList.add('active'); }
    function limpiarBusquedaInput() { document.getElementById('searchId').value = ''; }
    function limpiarResaltado() { document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight')); }
    function updateProgramSummaryFooter() { const { totalPonencias, totalSimposios } = fullSchedule.reduce((acc, mesa) => { if (mesa.esSimposio) acc.totalSimposios++; else acc.totalPonencias += mesa.items.filter(item => item.id !== 'DISC').length; return acc; }, { totalPonencias: 0, totalSimposios: 0 }); document.getElementById('program-summary-footer').innerHTML = `<h3>Resumen del Programa</h3><p>Total de Ponencias: <strong>${totalPonencias}</strong></p><p>Total de Simposios: <strong>${totalSimposios}</strong></p>`; }
    function addMinutes(time, mins) { const [hours, minutes] = time.split(':').map(Number); const date = new Date(); date.setHours(hours, minutes + mins, 0, 0); return date.toTimeString().slice(0, 5); }
    function showStatus(message, type = 'success') { const statusBar = document.getElementById('status-bar'); statusBar.textContent = message; statusBar.className = `status-${type}`; setTimeout(() => { statusBar.textContent = ''; statusBar.className = ''; }, 4000); }
    function updateURLHash() { const params = new URLSearchParams(); params.set('dia', currentDay); Object.entries(currentFilters).forEach(([key, value]) => { if (value !== 'all') params.set(key, value); }); history.replaceState(null, '', '#' + params.toString()); }
    function copyLinkToView() { navigator.clipboard.writeText(window.location.href).then(() => showStatus('¡Enlace a la vista actual copiado.', 'success')).catch(() => showStatus('No se pudo copiar el enlace.', 'error')); }
    function applyFiltersFromURL() { if (!window.location.hash) return; const params = new URLSearchParams(window.location.hash.substring(1)); const day = params.get('dia'); if (day && CONFIG.dias.some(d => d.nombre === day)) currentDay = day; ['sala', 'horario', 'type'].forEach(key => { if (params.has(key)) { currentFilters[key] = params.get(key); } }); }
</script>
</body>
</html>